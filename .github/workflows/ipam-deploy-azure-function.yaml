# This workflow deploys a the AIPAS IPAM Azure Function

name: IPAM-Deploy-Azure-Function

env:
  AZURE_FUNCTIONAPP_NAME: "fa-hmrc-uksouth-ipam"    
  AZURE_FUNCTIONAPP_PACKAGE_PATH: "./src/function/"  
  RESOURCEGROUPNAME: "rg-hmrc-uksouth-ipam"    
  SUBSCRIPTIONID: "ef620d24-2d5d-4e63-aaf9-e42cafb44dfb"  
  STORAGEACCOUNTNAME: "sahmrckyk4iqlcaxrvi"
  REGION: "uksouth" 

on:
  push:
    branches: [ none ]
  workflow_dispatch:

jobs:
  build-and-deploy-azurefunction:
    runs-on: self-hosted
    steps:
      - name: Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
        uses: actions/checkout@v2

      - name: Run PowerShell Bootstrap script
        run: .\bootstrap.ps1
        shell: pwsh

      - name: Copy IPAM PowerShell module to Azure Function
        run: Invoke-Build -Task CopyModuleFiles -File './aipas.build.ps1'
        shell: pwsh

      - name: Log on to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS}}
          enable-AzPSSession: true
          
      - name: Create Function App
        uses: azure/powershell@v1
        with:
          inlineScript: |
            New-AzFunctionApp -Name ${{ env.AZURE_FUNCTIONAPP_NAME }} -ResourceGroupName ${{ env.RESOURCEGROUPNAME }} -Location ${{ env.REGION }} -Runtime PowerShell -FunctionsVersion 3 -StorageAccountName ${{ env.STORAGEACCOUNTNAME }}
# ASP           New-AzFunctionAppPlan -Name ${{ env.AZURE_FUNCTIONAPP_NAME }} -ResourceGroupName ${{ env.RESOURCEGROUPNAME }} -Location ${{ env.REGION }} -WorkerType Windows -Sku EP1 
# ASP           New-AzFunctionApp -Name ${{ env.AZURE_FUNCTIONAPP_NAME }} -ResourceGroupName ${{ env.RESOURCEGROUPNAME }} -PlanName ${{ env.AZURE_FUNCTIONAPP_NAME }} -Runtime PowerShell -StorageAccountName ${{ env.STORAGEACCOUNTNAME }}
# ASE           New-AzAppServiceEnvironment -Name ${{ env.AZURE_FUNCTIONAPP_NAME }} -ResourceGroupName ${{ env.RESOURCEGROUPNAME }} -Location ${{ env.REGION }} -VirtualNetworkName vnet-ipam-01 -SubnetName snet-04 -Kind ASEv2 -LoadBalancerMode Internal
# ASE           New-AzAppServicePlan -Name ${{ env.AZURE_FUNCTIONAPP_NAME }} -ResourceGroupName ${{ env.RESOURCEGROUPNAME }} -Location ${{ env.REGION }} -AseName ${{ env.AZURE_FUNCTIONAPP_NAME }} -AseResourceGroupName ${{ env.RESOURCEGROUPNAME }} -NumberofWorkers 1 -WorkerSize "Small" -Tier Isolated
# ASE           New-AzFunctionApp -Name ${{ env.AZURE_FUNCTIONAPP_NAME }} -ResourceGroupName ${{ env.RESOURCEGROUPNAME }} -PlanName ${{ env.AZURE_FUNCTIONAPP_NAME }} -Runtime PowerShell -StorageAccountName ${{ env.STORAGEACCOUNTNAME }}
          azPSVersion: latest 

      - name: 'Run Azure Functions Action'
        uses: Azure/functions-action@v1
        id: fa
        with:
          app-name: ${{ env.AZURE_FUNCTIONAPP_NAME }}
          package: ${{ env.AZURE_FUNCTIONAPP_PACKAGE_PATH }}

      - name: 'Configure App Settings'
        uses: azure/appservice-settings@v1
        with:
          app-name: ${{ env.AZURE_FUNCTIONAPP_NAME }}
          app-settings-json: '${{ secrets.APP_SETTINGS }}'
        id: settings
