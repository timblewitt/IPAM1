# This workflow deploys the IPAM Azure Function

name: Deploy-IPAM

on:
  push:
    branches: [ none ]
  workflow_dispatch:

jobs:
  build-and-deploy-azurefunction:
    runs-on: windows-latest
    steps:
      - name: Check out repository under $GITHUB_WORKSPACE, so job can access it
        uses: actions/checkout@v2

      - name: Log on to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
          enable-AzPSSession: true
          
      - name: Create Function App
        uses: azure/powershell@v1
        with:
          inlineScript: |
            $networkAddresses = @(  "10.188.0.0/22",
                                    "10.188.64.0/22",
                                    "10.188.128.0/22",
                                    "10.188.192.0/22",
                                    "10.189.0.0/22",
                                    "10.189.64.0/22",
                                    "10.189.128.0/22",
                                    "10.189.192.0/22",
                                    "10.190.0.0/21",
                                    "10.190.32.0/21",
                                    "10.190.64.0/21",
                                    "10.190.96.0/21")             
            $mgmtSubName = "p001mgt"
            $connSubName = "p001con"
            $regionName = "uksouth"
            $regionId = "uks"
            $functionZipPath = "./src/ipam.zip"
            $aseDeploy = $true
            
            $aseVnetName = "vnet-$connSubName-$regionId-01"
            $aseVnetAddress = "10.50.0.0/16"
            $aseSnetName = 'snet-ipam'
            $aseSnetAddress = "10.50.10.0/24"
          azPSVersion: latest 
